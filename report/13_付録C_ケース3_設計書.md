## 付録C. ケース③で作成したドキュメント

#### (1) システム要件 ～作業者が作成～

```markdown: システム要件
## 概要

AWSのコストレポートをデータソースとしたBIツール

### 対象データ

- AWSの「エクスポート」機能を使用してS3にエクスポートされたコストレポートファイル
- AWS Organizationの管理アカウントから出力
  - 対象の組織アカウント: 約150アカウント

### 機能要件

- クエリエディタでSQLを入力して実行
  - 自然言語からクエリを生成する機能あり
- 出力は表形式とグラフ形式の２種類の出力があり
  - 生成AIを使用してグラフ出力
    - グラフ表示に使用するツールは選定中
  - 表は画面表示とエクスポートの2種類あり
    - 画面は1画面最大100行までのページングを実施
    - エクスポートはCSV形式
- 実行したクエリを記憶する機能あり
  - 記憶したクエリに対してタグをつけることができる。
  - nameタグや、その他のタグで検索可能

### システム構成

#### 運用環境

- AWS上に構築
- 構築にはterraformを使用する。
##### 使用するサービス

- EC2
- ECR
- DynamoDB
- S3
- Glue
- Athena
- ALB
- Cognito

```

```markdown: システム要件
##### AWSサービスの用途

###### IAM

- EC2のロールを管理
- terraform実行用のIAMユーザーを作成
- GitHubAction用にIDプロバイダを提供

###### EC2

- Amazonlinux2023
- 内部でdockerを起動
- ECRのアプリケーションリポジトリのlatestバージョンをpullして実行する
- ALBの背後に配置

###### ALB

- WEBサービスを公開
- ターゲットはEC2のオートスケーリンググループ

###### Route53

- システムのホストゾーンを作成
- ドメインは別アカウントで取得済みドメインのサブドメインを使用する

###### ECR

- アプリケーションコンテナイメージを格納

###### DynamoDB

- システムが記録する主要なデータを格納
  - クエリの実行履歴
  - クエリに紐づけたタグの情報

###### S3

- AWSのコストレポートファイル
- Athenaの実行結果
- terraformのtfstate

###### Glue

- AWSのコストレポートファイルのデータカタログを管理

###### Athena

- AWSのコストレポートファイルのデータカタログに対してクエリを実行

###### Cognito

- ユーザー認証を実行
  - Hosted UIを使用して認証、認証成功後、WEBシステムに認証ユーザー情報を送信する。

#### CD/CI

- CI
  - アプリケーション
    - アプリケーションのテストを実装
    - git push、pullrequestのタイミングで実装したテストを実行
  - インフラストラクチャ
    - terraformで実装
    - git push、pullrequestのタイミングでCI実行
      - tflint
      - tfvars
      - terraformのテストコード
- CD
  - GitHubアクションで実行
    - GitHubのUI「Action」タブ上で実行
    - タグをつけたコミットを選択してデプロイ
      - デプロイ先もUI上で選択する
  - CDプロセス
    - [GitHub Action] アプリケーションのコンテナをビルドしてECRにpushする
    - [GitHub Action] EC2のオートスケーリンググループに更新を指示
    - [AWS] EC2のオートスケーリンググループ内のEC2インスタンスを再起動
    - [AWS] EC2起動時にECRのlatestバージョンのイメージをpullしてdockerを起動
```

<div class="page-break"></div>

#### (2) AWSシステム構成 ～「(1) システム要件」からAIが作成～

```markdown:AWSシステム構成
# AWSシステム構成書

## 1. システム概要
AWSコストレポートをデータソースとしたBIツールで、AWS Organizationの約150アカウントのコストデータを可視化・分析します。

## 2. アーキテクチャ図
    ```
    +------------------+      +------------------+      +------------------+
    |                  |      |                  |      |                  |
    |   AWS コスト     | ---> |       S3         | ---> |      Glue        |
    |   (150アカウント) |      | (コストレポート) |      | (データカタログ) |
    |                  |      |                  |      |                  |
    +------------------+      +------------------+      +------------------+
                                                        |
                                                        v
    +------------------+      +------------------+      +------------------+
    |                  |      |                  |      |                  |
    |   Cognito認証    | <--- |       ALB        | <--- |    Route53       |
    |   (ユーザー認証) |      | (ロードバランサ) |      | (DNS/ドメイン)   |
    |                  |      |                  |      |                  |
    +------------------+      +------------------+      +------------------+
                                |
                                v
    +------------------+      +------------------+      +------------------+
    |                  |      |                  |      |                  |
    |   DynamoDB       | <--- |    EC2 (ASG)     | <--- |    ECR           |
    |   (クエリ履歴)   |      | (アプリケーション) |      | (コンテナレジストリ) |
    |                  |      |                  |      |                  |
    +------------------+      +------------------+      +------------------+
                                |
                                v
                          +------------------+
                          |                  |
                          |     Athena       |
                          | (クエリ実行)     |
                          |                  |
                          +------------------+
    ```

## 3. コンポーネント構成

### 3.1 ネットワーク構成
- **Route53**
  - ドメイン管理（既存ドメインのサブドメインを使用）
  - ALBへのルーティング設定
```

```markdown:AWSシステム構成


### 3.2 ロードバランサ
- **Application Load Balancer (ALB)**
  - インターネット向け
  - HTTPSリスナー（443ポート）
  - ターゲットグループ: EC2オートスケーリンググループ
  - アクセス制御: ソースIP制限（IPv4）

### 3.3 コンピューティング
- **EC2 オートスケーリンググループ**
  - インスタンスタイプ: t3a.medium（最新世代のバースト可能インスタンスタイプ）
    - vCPU: 2
    - メモリ: 4 GiB
    - ネットワークパフォーマンス: 最大5Gbps
  - 最小/最大/希望サイズ: 2/4/2
  - 起動テンプレート: Amazon Linux 2023（LTSバージョン）
  - ヘルスチェック: HTTP 80ポート
  - スケーリングポリシー: 
    - スケールアウト: CPU使用率70%を3分間超えた場合
    - スケールイン: CPU使用率30%を5分間下回った場合
  - インスタンス更新ポリシー: ローリングアップデートを有効化

### 3.4 ストレージ
- **Amazon S3**
  - バケット1: コストレポート用
    - ライフサイクルルール: 3年後にGlacier Deep Archiveへ移行
    - 暗号化: SSE-S3
  - バケット2: Athenaクエリ結果用
  - バケット3: Terraform状態管理用

- **DynamoDB**
  - テーブル1: クエリ履歴
    - パーティションキー: user_id
    - ソートキー: timestamp
  - テーブル2: クエリタグ
    - パーティションキー: query_id
    - ソートキー: tag_name
  - オンデマンドキャパシティーモード

### 3.5 データベース
- **Amazon Athena**
  - クエリ実行タイムアウト: 1分
  - 同時実行数: 10
  - ワークグループ: cost_analysis_workgroup

### 3.6 認証・認可
- **Amazon Cognito**
  - ユーザープール: ユーザー認証用
  - アプリクライアント: Webアプリケーション用
  - ホスト型UIを使用
  - グループ: 初期は全ユーザーにフルアクセス

## 4. データフロー

1. **データ収集**
   - AWSコストレポートが1日1回S3にエクスポート
   - GlueクローラーがS3のデータを定期的にスキャン
   - Glueデータカタログが更新

2. **クエリ実行**
    ```
    ユーザー
    → ALB (HTTPS 443)
    → EC2インスタンス (Dockerコンテナ)
    → Athena (クエリ実行)
    → S3 (結果保存)
    → ユーザーに結果表示
    ```

3. **クエリ保存**
   - 実行されたクエリはDynamoDBに保存
   - タグ付け機能で後から検索可能

## 5. セキュリティ

### 5.1 ネットワークセキュリティ
- VPC構成
  - パブリックサブネット: ALB配置
  - プライベートサブネット: EC2インスタンス配置
- セキュリティグループ
  - ALB: 443ポートのみ許可
  - EC2: ALBからのみ80ポート許可

### 5.2 データ保護
- データ暗号化
  - 保存時: S3バケットポリシーで暗号化を強制
  - 転送時: TLS 1.2以上を強制
- アクセス制御
  - IAMロールを使用した最小権限の原則
  - ソースIP制限（IPv4）

## 6. 監視・運用

### 6.1 監視項目
- **CloudWatch アラーム**
  - EC2 CPU使用率 > 80% (5分間)
  - ALB ターゲット応答時間 > 5秒 (5分間)
  - 5xxエラー率 > 1% (5分間)

### 6.2 ログ管理
- **CloudWatch Logs**
  - ALBアクセスログ
  - EC2システムログ
  - アプリケーションログ

## 7. バックアップ・ディザスタリカバリ

### 7.1 バックアップ
- **S3**
  - バージョニングを有効化
  - マルチリージョンレプリケーション（バックアップ用）
- **DynamoDB**
  - ポイントインタイムリカバリ (PITR) を有効化

### 7.2 ディザスタリカバリ
- マルチAZ構成で高可用性を確保
- 別リージョンへのフェイルオーバー手順をドキュメント化

## 8. コスト管理

### 8.1 コスト見積もり
- EC2: t3.medium x 2台 (常時稼働)
- EBS: gp3 50GB x 2台
- ALB: 1台
- S3: 500GB (月間増加量: 10GB)
- データ転送: 100GB/月

## 9. デプロイメント

### 9.1 インフラストラクチャ
- **Terraform**
  - モジュール化された構成
  - 環境ごとの変数管理
  - リモートステート管理 (S3 + DynamoDB)

### 9.2 CI/CDパイプライン
- **GitHub Actions**
  - プルリクエスト時: テスト実行
  - マージ時: ステージング環境へデプロイ
  - タグプッシュ時: 本番環境へデプロイ

## 10. 今後の拡張性

### 10.1 マルチテナント化
- CognitoグループとDynamoDBのパーティションキーを活用したデータ分離
- LakeFormationを使用したきめ細かいアクセス制御

### 10.2 パフォーマンス最適化
- クエリキャッシュの導入
- コストデータの集計テーブルの事前計算

### 10.3 機能拡張
- カスタムレポートの定期実行とメール配信
- コスト予測機能の追加
- コスト最適化の推奨事項の自動生成
```